AWSTemplateFormatVersion: "2010-09-09"

Transform:
  - AWS::Serverless-2016-10-31
Description: >-
  This creates the necessary components to deploy the Claimed Identity (CIC) FE onto ECS
  Fargate within an existing VPC and private subnets (imported parameters).
  Claimed Identity Front can be invoked via the public API Gateway on the url in the
  CICFrontURL output.

  The ingress route in summary is: API Gateway -> VPC link -> Private ALB ->
  CIC Front ECS Service

  CIC Front egress to CIC API's API Gateway is via a NAT Gateway which
  should have a route in the provided private subnets' route table.

Metadata:
  cfn-lint:
    config:
      ignore_checks:
      - W3005
      - W6001

Parameters:
  Environment:
    Description: "The environment type"
    Type: "String"
    Default: dev
    AllowedValues:
      - "dev"
      - "build"
      - "staging"
      - "integration"
      - "production"
  VpcStackName:
    Description: >
      The name of the stack that defines the VPC in which this container will
      run.
    Type: String
  PermissionsBoundary:
    Description: "The ARN of the permissions boundary to apply when creating IAM roles"
    Type: String
    Default: "none"
  EnableScalingInDev:
    Type: Number
    Default: 0
    Description: Set to 1 to enable deployment of scaling infra in dev
  IPVStubStackName:
    Type: String
    Default: "cic-ipv-stub"
    Description: The name of the deployed IPV stub stack.
  DeployAlarmsInDev:
    Description: "Set to the string value `true` to deploy alarms in a DEV environment"
    Type: String
    Default: false
  CodeSigningConfigArn:
    Description: The ARN of the Code Signing Config to use, provided by the deployment pipeline
    Type: String
    Default: none
  DeploymentStrategy:
    Description: "Predefined deployment configuration for ECS application"
    Type: String
    Default: "None"
    AllowedValues:
      - None
      - CodeDeployDefault.ECSCanary10Percent5Minutes
      - CodeDeployDefault.ECSCanary10Percent15Minutes
      - CodeDeployDefault.ECSAllAtOnce
      - CodeDeployDefault.ECSLinear10PercentEvery1Minutes
      - CodeDeployDefault.ECSLinear10PercentEvery3Minutes

Conditions:
  IsNotDevelopment: !Or
    - !Equals [ !Ref Environment, build ]
    - !Equals [ !Ref Environment, staging ]
    - !Equals [ !Ref Environment, integration ]
    - !Equals [ !Ref Environment, production ]
  IsProduction: !Equals [!Ref Environment, production]
  EnableScaling: !Or
    - !Equals [ !Ref EnableScalingInDev, 1]
    - !Equals [ !Ref Environment, build ]
    - !Equals [ !Ref Environment, staging ]
    - !Equals [ !Ref Environment, integration ]
    - !Equals [ !Ref Environment, production ]
  UsePermissionsBoundary:
    Fn::Not:
      - Fn::Equals:
          - !Ref PermissionsBoundary
          - "none"
  IsProdLikeEnvironment: !Or
    - !Equals [!Ref Environment, staging]
    - !Equals [!Ref Environment, integration]
    - !Equals [!Ref Environment, production]
  IsNotProdLikeEnvironment: !Not
    - !Condition IsProdLikeEnvironment
  DeployAlarms: !Or
    - Condition: IsNotDevelopment
    - !Equals [!Ref DeployAlarmsInDev, true]
  UseCodeSigning: !Not [!Equals [!Ref CodeSigningConfigArn, none]]
  UseCanaryDeployment: !Not
    - !Equals [!Ref DeploymentStrategy, "None"]

Mappings:
  PlatformConfiguration:
    dev:
      CSLSEGRESS: arn:aws:logs:eu-west-2:885513274347:destination:csls_cw_logs_destination_prodpython
    build:
      CSLSEGRESS: arn:aws:logs:eu-west-2:885513274347:destination:csls_cw_logs_destination_prodpython
    staging:
      CSLSEGRESS: arn:aws:logs:eu-west-2:885513274347:destination:csls_cw_logs_destination_prodpython
    integration:
      CSLSEGRESS: arn:aws:logs:eu-west-2:885513274347:destination:csls_cw_logs_destination_prodpython
    production:
      CSLSEGRESS: arn:aws:logs:eu-west-2:885513274347:destination:csls_cw_logs_destination_prodpython
# see https://docs.aws.amazon.com/elasticloadbalancing/latest/application/load-balancer-access-logs.html
  ElasticLoadBalancerAccountIds:
    eu-west-2:
      AccountId: 652711504416

  StaticVariables:
    urls:
      CICSupportManual: "https://govukverify.atlassian.net/wiki/spaces/Kiwi/pages/4371939527/6.3+CIC+CRI+Support+Documentation"

  EnvironmentVariables:
    ### These environment variables are referenced further down the file.
    ### Please ensure that any variables defined for an environment are defined for _all_ environments.
    dev:
      EXTERNALWEBSITEHOST: "https://cic-cri-front.review-c.dev.account.gov.uk"
      APIBASEURL: "https://api-cic-cri-api.review-c.dev.account.gov.uk"
      DNSSUFFIX: "review-c.dev.account.gov.uk"
      CLOUDFRONTDOMAIN: "d2mffc7h0tnarj.cloudfront.net"
      dynatraceSecretArn: arn:aws:secretsmanager:eu-west-2:216552277552:secret:DynatraceNonProductionVariables
      SESSIONTABLENAME: "cic-front-sessions-dev"
      GTMIDUA: "GTM-TK92W68"
      GTMIDGA4: "GTM-KD86CMZ"
      GA4ENABLED: "true"
      ANALYTICSDOMAIN: "dev.account.gov.uk"
      DEVICEINTELLIGENCEDOMAIN: "account.gov.uk"
      TESTHARNESSURL: "https://cic-test-harness-testharness.review-c.dev.account.gov.uk"
      BACKENDURL: "https://api-cic-cri-api.review-c.dev.account.gov.uk"
      BACKENDSESSIONTABLE: "session-cic-cri-ddb"
      LOGLEVEL: "debug"
      LANGUAGETOGGLEDISABLED: false
      DEVICEINTELLIGENCEENABLED: true
      MAY2025REBRANDENABLED: true
      minECSCount: 1
      maxECSCount: 4
    build:
      EXTERNALWEBSITEHOST: "https://review-c.build.account.gov.uk"
      APIBASEURL: "https://api.review-c.build.account.gov.uk"
      DNSSUFFIX: "review-c.build.account.gov.uk"
      CLOUDFRONTDOMAIN: "d3h3ilw9ijq9hg.cloudfront.net"
      dynatraceSecretArn: arn:aws:secretsmanager:eu-west-2:216552277552:secret:DynatraceNonProductionVariables
      SESSIONTABLENAME: "cic-front-sessions-build"
      GTMIDUA: "GTM-TK92W68"
      GTMIDGA4: "GTM-KD86CMZ"
      GA4ENABLED: "true"
      ANALYTICSDOMAIN: "build.account.gov.uk"
      DEVICEINTELLIGENCEDOMAIN: "account.gov.uk"
      TESTHARNESSURL: "https://testharness.review-c.build.account.gov.uk"
      BACKENDURL: "https://api.review-c.build.account.gov.uk"
      BACKENDSESSIONTABLE: "session-cic-cri-ddb"
      LOGLEVEL: "warn"
      LANGUAGETOGGLEDISABLED: false
      DEVICEINTELLIGENCEENABLED: true
      MAY2025REBRANDENABLED: true
      minECSCount: 6
      maxECSCount: 60
    staging:
      EXTERNALWEBSITEHOST: "https://review-c.staging.account.gov.uk"
      APIBASEURL: "https://api.review-c.staging.account.gov.uk"
      DNSSUFFIX: "review-c.staging.account.gov.uk"
      CLOUDFRONTDOMAIN: "d13b32us3mnyl9.cloudfront.net"
      dynatraceSecretArn: arn:aws:secretsmanager:eu-west-2:216552277552:secret:DynatraceNonProductionVariables
      SESSIONTABLENAME: "cic-front-sessions-staging"
      GTMIDUA: "GTM-TK92W68"
      GTMIDGA4: "GTM-KD86CMZ"
      GA4ENABLED: "true"
      ANALYTICSDOMAIN: "staging.account.gov.uk"
      DEVICEINTELLIGENCEDOMAIN: "account.gov.uk"
      TESTHARNESSURL: ""
      BACKENDURL: ""
      BACKENDSESSIONTABLE: ""
      LOGLEVEL: "warn"
      LANGUAGETOGGLEDISABLED: false
      DEVICEINTELLIGENCEENABLED: true
      MAY2025REBRANDENABLED: true
      minECSCount: 2
      maxECSCount: 4
    integration:
      EXTERNALWEBSITEHOST: "https://review-c.integration.account.gov.uk"
      APIBASEURL: "https://api.review-c.integration.account.gov.uk"
      DNSSUFFIX: "review-c.integration.account.gov.uk"
      CLOUDFRONTDOMAIN: "d1jx9t5yl02x1a.cloudfront.net"
      dynatraceSecretArn: arn:aws:secretsmanager:eu-west-2:216552277552:secret:DynatraceNonProductionVariables
      SESSIONTABLENAME: "cic-front-sessions-integration"
      GTMIDUA: "GTM-TK92W68"
      GTMIDGA4: "GTM-KD86CMZ"
      GA4ENABLED: "true"
      ANALYTICSDOMAIN: "integration.account.gov.uk"
      DEVICEINTELLIGENCEDOMAIN: "account.gov.uk"
      TESTHARNESSURL: ""
      BACKENDURL: ""
      BACKENDSESSIONTABLE: ""
      LOGLEVEL: "warn"
      LANGUAGETOGGLEDISABLED: false
      DEVICEINTELLIGENCEENABLED: true
      MAY2025REBRANDENABLED: true
      minECSCount: 2
      maxECSCount: 4
    production:
      EXTERNALWEBSITEHOST: "https://review-c.account.gov.uk"
      APIBASEURL: "https://api.review-c.account.gov.uk"
      DNSSUFFIX: "review-c.account.gov.uk"
      CLOUDFRONTDOMAIN: "d2ekguv8wcjy54.cloudfront.net"
      dynatraceSecretArn: arn:aws:secretsmanager:eu-west-2:216552277552:secret:DynatraceProductionVariables
      SESSIONTABLENAME: "cic-front-sessions-production"
      GTMIDUA: "GTM-TT5HDKV"
      GTMIDGA4: "GTM-K4PBJH3"
      GA4ENABLED: "true"
      ANALYTICSDOMAIN: "account.gov.uk"
      DEVICEINTELLIGENCEDOMAIN: "account.gov.uk"
      TESTHARNESSURL: ""
      BACKENDURL: ""
      BACKENDSESSIONTABLE: ""
      LOGLEVEL: "warn"
      LANGUAGETOGGLEDISABLED: false
      DEVICEINTELLIGENCEENABLED: true
      MAY2025REBRANDENABLED: true
      minECSCount: 6
      maxECSCount: 60

Resources:
  # Security Groups for the ECS service and load balancer
  LoadBalancerSG:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: >-
        CIC Front LoadBalancer Security Group
      SecurityGroupIngress:
        - CidrIp: 0.0.0.0/0
          Description: Allow from anyone on port 80
          FromPort: 80
          IpProtocol: tcp
          ToPort: 80
      VpcId:
        Fn::ImportValue:
          !Sub "${VpcStackName}-VpcId"

  LoadBalancerSGEgressToECSSecurityGroup:
    Type: 'AWS::EC2::SecurityGroupEgress'
    Properties:
      GroupId: !GetAtt LoadBalancerSG.GroupId
      IpProtocol: tcp
      Description: >-
        Egress between the CIC Front load balancer and
        the CIC Front ECS security group
      DestinationSecurityGroupId: !GetAtt ECSSecurityGroup.GroupId
      FromPort: 8080
      ToPort: 8080

  ECSSecurityGroup:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: >-
        CIC Front ECS Security Group permitting outbound
        to anywhere.
      SecurityGroupEgress:
        - CidrIp: 0.0.0.0/0
          Description: Allow all outbound traffic by default
          IpProtocol: '-1'
      VpcId:
        Fn::ImportValue:
          !Sub "${VpcStackName}-VpcId"

  ECSSecurityGroupIngressFromLoadBalancer:
    Type: 'AWS::EC2::SecurityGroupIngress'
    Properties:
      IpProtocol: tcp
      Description: >-
        CIC Front ECS permits inbound from the CIC Front
        load balancer.
      FromPort: 8080
      ToPort: 8080
      GroupId: !GetAtt ECSSecurityGroup.GroupId
      SourceSecurityGroupId: !GetAtt LoadBalancerSG.GroupId

  AccessLogsBucket:
    Condition: IsNotDevelopment
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub cic-front-${Environment}-access-logs
      VersioningConfiguration:
        Status: "Enabled"
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256

  CICFrontAccessLogsBucketPolicy:
    Condition: IsNotDevelopment
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref AccessLogsBucket
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              AWS: !Sub
                - "arn:aws:iam::${ElbAccountId}:root"
                - ElbAccountId: !FindInMap [ ElasticLoadBalancerAccountIds, !Ref AWS::Region, AccountId ]
            Action:
              - s3:PutObject
            Resource:
              - !Sub arn:aws:s3:::${AccessLogsBucket}/cic-front-${Environment}/AWSLogs/${AWS::AccountId}/*

  # Private Application Load Balancer
  LoadBalancer:
    Type: 'AWS::ElasticLoadBalancingV2::LoadBalancer'
    Properties:
      Scheme: internal
      SecurityGroups:
        - !GetAtt LoadBalancerSG.GroupId
      Subnets:
        - Fn::ImportValue:
            !Sub "${VpcStackName}-PrivateSubnetIdA"
        - Fn::ImportValue:
            !Sub "${VpcStackName}-PrivateSubnetIdB"
      Type: application
      LoadBalancerAttributes: !If
        - IsNotDevelopment
        - - Key: access_logs.s3.enabled
            Value: true
          - Key: access_logs.s3.bucket
            Value: !Ref AccessLogsBucket
          - Key: access_logs.s3.prefix
            Value: !Sub cic-front-${Environment}
          - Key: routing.http.drop_invalid_header_fields.enabled
            Value: true
        - !Ref AWS::NoValue
      Tags:
        - Key: FMSRegionalPolicy
          Value: false

  LoadBalancerListenerTargetGroupECS:
    Type: 'AWS::ElasticLoadBalancingV2::TargetGroup'
    Properties:
      HealthCheckEnabled: TRUE
      HealthCheckProtocol: HTTP
      HealthCheckPath: /healthcheck
      HealthCheckTimeoutSeconds: 2
      HealthCheckIntervalSeconds: 5
      HealthyThresholdCount: 2
      Matcher:
        HttpCode: 200-499
      Port: 80
      Protocol: HTTP
      TargetType: ip
      VpcId:
        Fn::ImportValue:
          !Sub "${VpcStackName}-VpcId"
      TargetGroupAttributes:
        - Key: deregistration_delay.timeout_seconds
          Value: 60

  GreenTargetGroupECS:
    Type: 'AWS::ElasticLoadBalancingV2::TargetGroup'
    Properties:
      HealthCheckEnabled: TRUE
      HealthCheckProtocol: HTTP
      Matcher:
        HttpCode: 200-499
      Port: 80
      Protocol: HTTP
      TargetType: ip
      VpcId:
        Fn::ImportValue:
          !Sub "${VpcStackName}-VpcId"
      TargetGroupAttributes:
        - Key: deregistration_delay.timeout_seconds
          Value: 60

  ECSCanaryDeploymentStack:
    Type: AWS::CloudFormation::Stack
    Condition: UseCanaryDeployment
    Properties:
      TemplateURL: https://template-storage-templatebucket-1upzyw6v9cs42.s3.amazonaws.com/ecs-canary-deployment/template.yaml
      Parameters:
        VpcId: !Sub ${VpcStackName}-VpcId
        PermissionsBoundary:
          Fn::ImportValue: !Sub "${AWS::StackName}-ECSCanaryPermissionsBoundaryArn"
        CodeSigningConfigArn: !If
          - UseCodeSigning
          - !Ref CodeSigningConfigArn
          - !Ref AWS::NoValue
        ECSClusterName: !Ref CICFrontEcsCluster
        ECSServiceName: !GetAtt CICFrontEcsService.Name
        TargetGroupName: !GetAtt LoadBalancerListenerTargetGroupECS.TargetGroupName
        GreenTargetGroupName: !GetAtt GreenTargetGroupECS.TargetGroupName
        LoadBalancerListenerARN: !Ref LoadBalancerListener
        ECSServiceTaskDefinition: !Ref ECSServiceTaskDefinition
        DeploymentStrategy: !Ref DeploymentStrategy
        ContainerName: "app"
        ContainerPort: 8080
        Subnets: !Join
          - ","
          - - Fn::ImportValue:
                !Sub "${VpcStackName}-ProtectedSubnetIdA"
            - Fn::ImportValue:
                !Sub "${VpcStackName}-ProtectedSubnetIdB"
        SecurityGroups: !GetAtt ECSSecurityGroup.GroupId
        CloudWatchAlarms: !Sub
          - "${ELB5XXAlarm}"
          - ELB5XXAlarm: !Ref ELB5XXAlarm

  ELB5XXAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmDescription: >
        The number of HTTP 5XX server error codes that originate from the load balancer.
        This count does not include any response codes generated by the targets.
      MetricName: HTTPCode_ELB_5XX_Count
      Namespace: AWS/ApplicationELB
      Statistic: Sum
      Dimensions:
        - Name: LoadBalancer
          Value: !Ref LoadBalancer
      Period: 60
      EvaluationPeriods: 2
      DatapointsToAlarm: 2
      Threshold: 2
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching

  LoadBalancerListener:
    Type: 'AWS::ElasticLoadBalancingV2::Listener'
    Properties:
      DefaultActions:
        - TargetGroupArn: !Ref LoadBalancerListenerTargetGroupECS
          Type: forward
      LoadBalancerArn: !Ref LoadBalancer
      Port: 80
      Protocol: HTTP

  # ECS cluster, service
  CICFrontEcsCluster:
    Type: 'AWS::ECS::Cluster'
    Properties:
      ClusterSettings:
        - Name: containerInsights
          Value: enabled
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-ECSCluster"
        - Key: Product
          Value: "GOV.UK One login"
        - Key: System
          Value: "CIC"
        - Key: Environment
          Value: !Sub "${Environment}"

  CICFrontEcsService:
    Type: 'AWS::ECS::Service'
    Properties:
      Cluster: !Ref CICFrontEcsCluster
      DeploymentController:
        Type: !If
          - UseCanaryDeployment
          - CODE_DEPLOY
          - ECS
      DeploymentConfiguration: !If
        - UseCanaryDeployment
        - !Ref AWS::NoValue
        - MaximumPercent: 200
          MinimumHealthyPercent: 50
          DeploymentCircuitBreaker:
            Enable: TRUE
            Rollback: TRUE
      DesiredCount: !FindInMap [EnvironmentVariables, !Ref Environment, minECSCount]
      EnableECSManagedTags: false
      HealthCheckGracePeriodSeconds: !If
        - UseCanaryDeployment
        - !Ref AWS::NoValue
        - 60
      LaunchType: FARGATE
#      LoadBalancers:
#        - ContainerName: app
#          ContainerPort: 8080
#          TargetGroupArn: !Ref LoadBalancerListenerTargetGroupECS
#      NetworkConfiguration:
#        AwsvpcConfiguration:
#          AssignPublicIp: DISABLED
#          SecurityGroups:
#            - !GetAtt ECSSecurityGroup.GroupId
#          Subnets:
#            - Fn::ImportValue:
#                !Sub "${VpcStackName}-ProtectedSubnetIdA"
#            - Fn::ImportValue:
#                !Sub "${VpcStackName}-ProtectedSubnetIdB"
#      TaskDefinition: !Ref ECSServiceTaskDefinition
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-ECS"
        - Key: Product
          Value: "GOV.UK One login"
        - Key: System
          Value: "CIC"
        - Key: Environment
          Value: !Sub "${Environment}"
    DependsOn:
      - LoadBalancerListener

  ECSAccessLogsGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub /aws/ecs/${AWS::StackName}-CICFront-ECS
      RetentionInDays: 30

  CSLSECSAccessSubscriptionFilter:
    Type: AWS::Logs::SubscriptionFilter
    # Condition: IsNotDevelopment
    Properties:
      DestinationArn:
        !FindInMap [PlatformConfiguration, !Ref Environment, CSLSEGRESS]
      FilterPattern: ""
      LogGroupName: !Ref ECSAccessLogsGroup

  ECSFatalErorMetricFilter:
    Type: AWS::Logs::MetricFilter
    Condition: IsNotDevelopment
    Properties:
      LogGroupName: !Ref ECSAccessLogsGroup
      FilterPattern: '{ $.level = "FATAL" || $.message = "Unhandled Exception:*" }'
      MetricTransformations:
        -
          MetricValue: "1"
          MetricNamespace: !Sub "${AWS::StackName}/LogMessages"
          MetricName: "ECSFatalerror-message"

  ECSFatalErrorAlarm:
    DependsOn:
      - "ECSFatalErorMetricFilter"
    Type: AWS::CloudWatch::Alarm
    Condition: IsNotDevelopment
    Properties:
      AlarmName: !Sub "${AWS::StackName}-ECSFatalErrorAlarm"
      AlarmDescription: !Sub 
        - "Trigger an alarm when Fatal Error occurs ${RunbookUrl}"
        - RunbookUrl: !FindInMap [StaticVariables, urls, CICSupportManual]
      ActionsEnabled: true
      OKActions:
        - !ImportValue platform-alarm-pagerduty-alert-topic
        - !ImportValue platform-alarm-topic-critical-alert
      AlarmActions:
        - !ImportValue platform-alarm-pagerduty-alert-topic
        - !ImportValue platform-alarm-topic-critical-alert
      InsufficientDataActions: [ ]
      MetricName: ECSFatalerror-message
      Namespace: !Sub "${AWS::StackName}/LogMessages"
      Statistic: Sum
      Dimensions: [ ]
      Period: 60
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching

  EventLoopDelayMetricFilter:
    Type: AWS::Logs::MetricFilter
    Properties:
      LogGroupName: !Ref ECSAccessLogsGroup
      FilterPattern: "{($.eventLoopDelay = *)}"
      MetricTransformations:
        - MetricValue: $.eventLoopDelay
          MetricName: EventLoopDelay
          MetricNamespace: !Sub ${AWS::StackName}/LogMessages

  EventLoopUtilizationIdleMetricFilter:
    Type: AWS::Logs::MetricFilter
    Properties:
      LogGroupName: !Ref ECSAccessLogsGroup
      FilterPattern: "{ $.eventLoopUtilization.idle = * }"
      MetricTransformations:
        - MetricValue: $.eventLoopUtilization.idle
          MetricName: EventLoopUtilizationIdle
          MetricNamespace: !Sub ${AWS::StackName}/LogMessages

  EventLoopUtilizationActiveMetricFilter:
    Type: AWS::Logs::MetricFilter
    Properties:
      LogGroupName: !Ref ECSAccessLogsGroup
      FilterPattern: "{ $.eventLoopUtilization.active = * }"
      MetricTransformations:
        - MetricValue: $.eventLoopUtilization.active
          MetricName: EventLoopUtilizationActive
          MetricNamespace: !Sub ${AWS::StackName}/LogMessages

  EventLoopUtilizationUtilizationMetricFilter:
    Type: AWS::Logs::MetricFilter
    Properties:
      LogGroupName: !Ref ECSAccessLogsGroup
      FilterPattern: "{ $.eventLoopUtilization.utilization = * }"
      MetricTransformations:
        - MetricValue: $.eventLoopUtilization.utilization
          MetricName: EventLoopUtilizationUtilization
          MetricNamespace: !Sub ${AWS::StackName}/LogMessages

  RequestsPerSecondMetricFilter:
    Type: AWS::Logs::MetricFilter
    Properties:
      LogGroupName: !Ref ECSAccessLogsGroup
      FilterPattern: "{ $.requestsPerSecond.dynamic = * }"
      MetricTransformations:
        - MetricValue: $.requestsPerSecond.dynamic
          MetricName: RequestsPerSecond
          MetricNamespace: !Sub ${AWS::StackName}/LogMessages
          Unit: Count/Second

  AvgResponseTimeMetricFilter:
    Type: AWS::Logs::MetricFilter
    Properties:
      LogGroupName: !Ref ECSAccessLogsGroup
      FilterPattern: "{ $.avgResponseTime.dynamic = * }"
      MetricTransformations:
        - MetricValue: $.avgResponseTime.dynamic
          MetricName: AvgResponseTime
          MetricNamespace: !Sub ${AWS::StackName}/LogMessages
          Unit: Count/Second

  MaxConcurrentConnectionsMetricFilter:
    Type: AWS::Logs::MetricFilter
    Properties:
      LogGroupName: !Ref ECSAccessLogsGroup
      FilterPattern: "{ $.maxConcurrentConnections = * }"
      MetricTransformations:
        - MetricValue: $.maxConcurrentConnections
          MetricName: MaxConcurrentConnections
          MetricNamespace: !Sub ${AWS::StackName}/LogMessages
          Unit: Count

  #
  # Fargate tasks
  #
  ECSServiceTaskDefinition:
    Type: 'AWS::ECS::TaskDefinition'
    Properties:
      ContainerDefinitions:
        - Essential: true
          Image: CONTAINER-IMAGE-PLACEHOLDER
          Name: app
          Environment:
            - Name: API_BASE_URL
              Value: !FindInMap [EnvironmentVariables, !Ref Environment, APIBASEURL ]
            - Name: EXTERNAL_WEBSITE_HOST
              Value: !FindInMap [EnvironmentVariables, !Ref Environment, EXTERNALWEBSITEHOST ]
            - Name: SESSION_TABLE_NAME
              Value: !Ref CicFrontSessionsTable
            - Name: FRONT_END_URL
              Value: !FindInMap [EnvironmentVariables, !Ref Environment, EXTERNALWEBSITEHOST ]
            - Name: UNIVERSAL_ANALYTICS_GTM_CONTAINER_ID
              Value: !FindInMap [ EnvironmentVariables, !Ref Environment, GTMIDUA ]
            - Name: GOOGLE_ANALYTICS_4_GTM_CONTAINER_ID
              Value: !FindInMap [ EnvironmentVariables, !Ref Environment, GTMIDGA4 ]
            - Name: GA4_ENABLED
              Value: !FindInMap [ EnvironmentVariables, !Ref Environment, GA4ENABLED ]
            - Name: FRONTEND_DOMAIN
              Value:
                !If [
                  IsProduction,
                  "account.gov.uk",
                  !Sub "${Environment}.account.gov.uk"
                ]
            - Name: DEVICE_INTELLIGENCE_DOMAIN
              Value: !FindInMap [ EnvironmentVariables, !Ref Environment, DEVICEINTELLIGENCEDOMAIN ]
            - Name: LOG_LEVEL
              Value: !FindInMap [EnvironmentVariables, !Ref Environment, LOGLEVEL ]
            - Name: LANGUAGE_TOGGLE_DISABLED
              Value: !FindInMap [EnvironmentVariables, !Ref Environment, LANGUAGETOGGLEDISABLED ]
            - Name: DEVICE_INTELLIGENCE_ENABLED
              Value: !FindInMap [EnvironmentVariables, !Ref Environment, DEVICEINTELLIGENCEENABLED ]
            - Name: MAY_2025_REBRAND_ENABLED
              Value: !FindInMap [EnvironmentVariables, !Ref Environment, MAY2025REBRANDENABLED ]
          Secrets:
            - Name: DT_TENANT
              ValueFrom: !Join
                - ''
                - - !FindInMap [ EnvironmentVariables, !Ref Environment, dynatraceSecretArn ]
                  - ':DT_TENANT::'
            - Name: DT_TENANTTOKEN
              ValueFrom: !Join
                - ''
                - - !FindInMap [ EnvironmentVariables, !Ref Environment, dynatraceSecretArn ]
                  - ':DT_TENANTTOKEN::'
            - Name: DT_CONNECTION_POINT
              ValueFrom: !Join
              - ''
              - - !FindInMap [ EnvironmentVariables, !Ref Environment, dynatraceSecretArn ]
                - ':DT_CONNECTION_POINT::'
          PortMappings:
            - ContainerPort: 8080
              Protocol: tcp
          HealthCheck:
            Command:
              - "CMD-SHELL"
              - "curl -f http://localhost:8080/healthcheck || exit 1"
            Interval: 5
            Retries: 10
            Timeout: 2
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group : !Ref ECSAccessLogsGroup
              awslogs-region : !Sub ${AWS::Region}
              awslogs-stream-prefix : !Sub cic-front-${Environment}
      Cpu: '1024'
      ExecutionRoleArn: !GetAtt ECSTaskExecutionRole.Arn
      Memory: '2048'
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      TaskRoleArn: !GetAtt ECSTaskRole.Arn
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-TaskDefinition"
        - Key: Product
          Value: "GOV.UK One login"
        - Key: System
          Value: "CIC"
        - Key: Environment
          Value: !Sub "${Environment}"

  ECSTaskExecutionRole:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
        Version: 2012-10-17
      Policies:
        - PolicyName: PullCICFrontImage
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - "ecr:BatchGetImage"
                  - "ecr:GetDownloadUrlForLayer"
                  - "ecr:GetAuthorizationToken"
                Resource:
                  - '*'
              - Effect: Allow
                Action:
                  - "logs:CreateLogStream"
                  - "logs:PutLogEvents"
                Resource:
                  - !GetAtt "ECSAccessLogsGroup.Arn"
                  - !Sub "${ECSAccessLogsGroup.Arn}:*"
        - PolicyName: DynatraceGetSecrets
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - "secretsmanager:GetSecretValue"
                Resource:
                  - "arn:aws:secretsmanager:eu-west-2:216552277552:secret:DynatraceNonProductionVariables*"
                  - "arn:aws:secretsmanager:eu-west-2:216552277552:secret:DynatraceProductionVariables*"
              - Effect: Allow
                Action:
                  - "secretsmanager:ListSecrets"
                Resource:
                  - "arn:aws:secretsmanager:eu-west-2:216552277552:secret:*"
              - Effect: Allow
                Action:
                  - "kms:Decrypt"
                Resource:
                  - "arn:aws:kms:eu-west-2:216552277552:key/*"
      PermissionsBoundary: !If
        - UsePermissionsBoundary
        - !Ref PermissionsBoundary
        - !Ref AWS::NoValue

  ECSTaskRole:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
        Version: 2012-10-17
      Policies:
        - PolicyName: CicFrontDynamoDBSessionAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - "dynamodb:BatchGetItem"
                  - "dynamodb:DescribeTable"
                  - "dynamodb:GetItem"
                  - "dynamodb:Query"
                  - "dynamodb:Scan"
                  - "dynamodb:BatchWriteItem"
                  - "dynamodb:DeleteItem"
                  - "dynamodb:UpdateItem"
                  - "dynamodb:PutItem"
                Resource:
                  - !GetAtt CicFrontSessionsTable.Arn
        - PolicyName: DynatraceGetSecrets
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - "secretsmanager:GetSecretValue"
                Resource:
                  - "arn:aws:secretsmanager:eu-west-2:216552277552:secret:DynatraceNonProductionVariables*"
                  - "arn:aws:secretsmanager:eu-west-2:216552277552:secret:DynatraceProductionVariables*"
              - Effect: Allow
                Action:
                  - "secretsmanager:ListSecrets"
                Resource:
                  - "arn:aws:secretsmanager:eu-west-2:216552277552:secret:*"
              - Effect: Allow
                Action:
                  - "kms:Decrypt"
                Resource:
                  - "arn:aws:kms:eu-west-2:216552277552:key/*"
      PermissionsBoundary: !If
        - UsePermissionsBoundary
        - !Ref PermissionsBoundary
        - !Ref AWS::NoValue

  #
  # API Gateway
  #
  #

  ApiGwHttpEndpoint:
    Type: 'AWS::ApiGatewayV2::Api'
    Properties:
      Name: !If
        - IsNotDevelopment
        - !Sub "cic-front-${Environment}"
        - !Sub "cic-front-${Environment}-${AWS::StackName}"
      ProtocolType: HTTP

  ApiGwHttpEndpointIntegration:
    Type: 'AWS::ApiGatewayV2::Integration'
    Properties:
      ApiId: !Ref ApiGwHttpEndpoint
      IntegrationType: HTTP_PROXY
      ConnectionId:
        Fn::ImportValue:
          !Sub "${VpcStackName}-VpcLinkId"
      ConnectionType: VPC_LINK
      IntegrationMethod: ANY
      IntegrationUri: !Ref LoadBalancerListener
      PayloadFormatVersion: '1.0'

  APIGWRoute:
    Type: 'AWS::ApiGatewayV2::Route'
    Properties:
      ApiId: !Ref ApiGwHttpEndpoint
      RouteKey: 'ANY /{proxy+}'
      Target: !Join
        - /
        - - integrations
          - !Ref ApiGwHttpEndpointIntegration

  APIStageDefault:
    Type: 'AWS::ApiGatewayV2::Stage'
    Properties:
      ApiId: !Ref ApiGwHttpEndpoint
      StageName: $default
      AutoDeploy: true
      DefaultRouteSettings:
        DataTraceEnabled: false
        DetailedMetricsEnabled: true
        ThrottlingBurstLimit: 400
        ThrottlingRateLimit: 200
      AccessLogSettings:
        DestinationArn: !GetAtt APIGWAccessLogsGroup.Arn
        Format: >-
          {
          "requestId":"$context.requestId",
          "ip": "$context.identity.sourceIp",
          "requestTime":"$context.requestTime",
          "httpMethod":"$context.httpMethod",
          "path": "$context.path",
          "routeKey":"$context.routeKey",
          "status":"$context.status",
          "protocol":"$context.protocol",
          "responseLength":"$context.responseLength",
          "responseLatency":"$context.responseLatency",
          "integrationLatency":"$context.integrationLatency"
          }

  CloudFrontWAFv2ACLAssociation:
    Type: AWS::WAFv2::WebACLAssociation
    Properties:
      ResourceArn: !Ref LoadBalancer
      WebACLArn: !ImportValue cfront-origin-distrib-CloakingOriginWebACLArn

  APIGWAccessLogsGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub /aws/apigateway/${AWS::StackName}-CICFront-API-GW-AccessLogs
      RetentionInDays: 30

  CSLSAPIGWAccessSubscriptionFilter:
    Type: AWS::Logs::SubscriptionFilter
    Condition: IsNotDevelopment
    Properties:
      DestinationArn:
        !FindInMap [PlatformConfiguration, !Ref Environment, CSLSEGRESS]
      FilterPattern: ""
      LogGroupName: !Ref APIGWAccessLogsGroup

  APIGWFatalErorMetricFilter:
    Type: AWS::Logs::MetricFilter
    Condition: IsNotDevelopment
    Properties:
      LogGroupName: !Ref APIGWAccessLogsGroup
      FilterPattern: '{ $.level = "FATAL" || $.message = "Unhandled Exception:*" }'
      MetricTransformations:
        -
          MetricValue: "1"
          MetricNamespace: !Sub "${AWS::StackName}/LogMessages"
          MetricName: "APIGWFatalerror-message"

  APIGWFatalErrorAlarm:
    DependsOn:
      - "APIGWFatalErorMetricFilter"
    Type: AWS::CloudWatch::Alarm
    Condition: IsNotDevelopment
    Properties:
      AlarmName: !Sub "${AWS::StackName}-APIGWFatalErrorAlarm"
      AlarmDescription: !Sub 
        - "Trigger an alarm when Fatal Error occurs ${RunbookUrl}"
        - RunbookUrl: !FindInMap [StaticVariables, urls, CICSupportManual]
      ActionsEnabled: true
      OKActions:
        - !ImportValue platform-alarm-pagerduty-alert-topic
        - !ImportValue platform-alarm-topic-critical-alert
      AlarmActions:
        - !ImportValue platform-alarm-pagerduty-alert-topic
        - !ImportValue platform-alarm-topic-critical-alert
      InsufficientDataActions: [ ]
      MetricName: APIGWFatalerror-message
      Namespace: !Sub "${AWS::StackName}/LogMessages"
      Statistic: Sum
      Dimensions: [ ]
      Period: 60
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching


  # Autoscaling
  # The number of pods will increase when the configured CPU utilization is breached for more than 3 minutes.
  # Scaling down will occur after 15 minutes of 90% utilization of the configured CPU utilization.

  ECSAutoScalingTarget:
    Type: AWS::ApplicationAutoScaling::ScalableTarget
    Properties:
      MinCapacity:
        !FindInMap [EnvironmentVariables, !Ref Environment, minECSCount]
      MaxCapacity:
        !FindInMap [EnvironmentVariables, !Ref Environment, maxECSCount]
      ResourceId: !Join
        - '/'
        - - "service"
          - !Ref   CICFrontEcsCluster
          - !GetAtt CICFrontEcsService.Name
      RoleARN: !Sub "arn:aws:iam::${AWS::AccountId}:role/aws-service-role/ecs.application-autoscaling.amazonaws.com/AWSServiceRoleForApplicationAutoScaling_ECSService"
      ScalableDimension: ecs:service:DesiredCount
      ServiceNamespace: ecs

  EcsStepScaleOutPolicy:
    DependsOn: ECSAutoScalingTarget
    Type: AWS::ApplicationAutoScaling::ScalingPolicy
    Properties:
      PolicyName: EcsStepScalingOutPolicy
      PolicyType: StepScaling
      ResourceId: !Join
        - "/"
        - - "service"
          - !Ref CICFrontEcsCluster
          - !GetAtt CICFrontEcsService.Name
      ScalableDimension: ecs:service:DesiredCount
      ServiceNamespace: ecs
      StepScalingPolicyConfiguration:
        AdjustmentType: PercentChangeInCapacity
        Cooldown:
          180 # The policy will continue to respond to additional alarm breaches,
          # even while a scaling activity is in progress. This means Application
        # Auto Scaling will evaluate all alarm breaches as they occur.
        # A cooldown period is used to protect against over-scaling due to
        # multiple alarm breaches occurring in rapid succession.
        MinAdjustmentMagnitude: 1
        StepAdjustments:
          - MetricIntervalUpperBound: 0 # 60%
            ScalingAdjustment: 100 # Scale by 100% of containers if the metric is breached
            # with <60% utilisation
          - MetricIntervalLowerBound: 0 # 60%
            MetricIntervalUpperBound: 30 # 90%
            ScalingAdjustment: 200 # Scale by 200% of containers if the metric is breached
            # with 80-90% utilisation
          - MetricIntervalLowerBound: 30 # 90%
            MetricIntervalUpperBound: 35 # 95%
            ScalingAdjustment: 300 # Scale by 300% of containers if the metric is breached
            # with 90-95% utilisation
          - MetricIntervalLowerBound: 35 # 95%
            ScalingAdjustment:
              500 # Scale by 500% of containers if the metric is breached
            # with >95% utilisation
            # Note: CPU can scale greater than 100% in a burst mode
            # on Fargate, so leave the upper bound open

  EcsStepScaleInPolicy:
    DependsOn: ECSAutoScalingTarget
    Type: AWS::ApplicationAutoScaling::ScalingPolicy
    Properties:
      PolicyName: EcsStepScalingInPolicy
      PolicyType: StepScaling
      ResourceId: !Join
        - "/"
        - - "service"
          - !Ref CICFrontEcsCluster
          - !GetAtt CICFrontEcsService.Name
      ScalableDimension: ecs:service:DesiredCount
      ServiceNamespace: ecs
      StepScalingPolicyConfiguration:
        AdjustmentType: PercentChangeInCapacity
        Cooldown:
          180 # The policy will continue to respond to additional alarm breaches,
          # even while a scaling activity is in progress. This means Application
        # Auto Scaling will evaluate all alarm breaches as they occur.
        # A cooldown period is used to protect against under-scaling due to
        # multiple alarm breaches occurring in rapid succession.
        StepAdjustments:
          - MetricIntervalUpperBound: -15 # 5%
            ScalingAdjustment: -90 # Scale down by 90% of containers if the metric is breached
            # with <5% utilisation
          - MetricIntervalLowerBound: -15 # 5%
            MetricIntervalUpperBound: 0 # 20%
            ScalingAdjustment:
              -50 # Scale down 50% of containers if the metric is breached
            # with <20% utilisation

  EcsStepScaleOutAlarm:
    DependsOn: ECSAutoScalingTarget
    Type: AWS::CloudWatch::Alarm
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !Ref EcsStepScaleOutPolicy
      AlarmDescription: "EcsClusterOver60PercentCPU"
      ComparisonOperator: "GreaterThanThreshold"
      DatapointsToAlarm: "1"
      Dimensions:
        - Name: ClusterName
          Value: !Ref CICFrontEcsCluster
        - Name: ServiceName
          Value: !GetAtt CICFrontEcsService.Name
      Unit: "Percent"
      EvaluationPeriods: "2"
      MetricName: "CPUUtilization"
      Namespace: "AWS/ECS"
      Statistic: "Average"
      Period: "60"
      Threshold: "60"

  EcsStepScaleInAlarm:
    DependsOn: ECSAutoScalingTarget
    Type: AWS::CloudWatch::Alarm
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !Ref EcsStepScaleInPolicy
      AlarmDescription: "EcsClusterUnder60PercentCPU"
      ComparisonOperator: "LessThanThreshold"
      DatapointsToAlarm: "5"
      Dimensions:
        - Name: ClusterName
          Value: !Ref CICFrontEcsCluster
        - Name: ServiceName
          Value: !GetAtt CICFrontEcsService.Name
      Unit: "Percent"
      EvaluationPeriods: "5"
      MetricName: "CPUUtilization"
      Namespace: "AWS/ECS"
      Statistic: "Average"
      Period: "60"
      Threshold: "20"

  ### Front End API Gateway Custom Domain definition

  CICFrontCustomDomain:
    Type: AWS::ApiGatewayV2::DomainName
    Properties:
      DomainName: !If
      - IsNotDevelopment
      - !Sub
        - "www.${DNSSUFFIX}"
        - DNSSUFFIX: !FindInMap [EnvironmentVariables, !Ref Environment, DNSSUFFIX]
      - !Sub
        - "${AWS::StackName}.${DNSSUFFIX}"
        - DNSSUFFIX: !FindInMap [EnvironmentVariables, !Ref Environment, DNSSUFFIX]
      DomainNameConfigurations:
        - CertificateArn: !Sub "{{resolve:ssm:/${Environment}/Platform/ACM/PrimaryZoneWildcardCertificateARN}}"
          EndpointType: REGIONAL
          SecurityPolicy: TLS_1_2

  CICFrontApiRecord:
    Type: AWS::Route53::RecordSet
    Properties:
      Name: !If
      - IsNotDevelopment
      - !Sub
        - "www.${DNSSUFFIX}"
        - DNSSUFFIX: !FindInMap [EnvironmentVariables, !Ref Environment, DNSSUFFIX]
      - !Sub
        - "${AWS::StackName}.${DNSSUFFIX}"
        - DNSSUFFIX: !FindInMap [EnvironmentVariables, !Ref Environment, DNSSUFFIX]
      Type: A
      HostedZoneId: !Sub "{{resolve:ssm:/${Environment}/Platform/Route53/PrimaryZoneID}}"
      AliasTarget:
        DNSName:  !FindInMap [EnvironmentVariables, !Ref Environment, CLOUDFRONTDOMAIN]
        HostedZoneId: Z2FDTNDATAQYW2
        EvaluateTargetHealth: false

  CICFrontApiOriginRecord:
    Type: AWS::Route53::RecordSet
    Properties:
      Name: !If
      - IsNotDevelopment
      - !Sub
        - "origin.${DNSSUFFIX}"
        - DNSSUFFIX: !FindInMap [EnvironmentVariables, !Ref Environment, DNSSUFFIX]
      - !Sub
        - "origin.${AWS::StackName}.${DNSSUFFIX}"
        - DNSSUFFIX: !FindInMap [EnvironmentVariables, !Ref Environment, DNSSUFFIX]
      Type: A
      HostedZoneId: !Sub "{{resolve:ssm:/${Environment}/Platform/Route53/PrimaryZoneID}}"
      AliasTarget:
        DNSName: !GetAtt CICFrontCustomDomain.RegionalDomainName
        HostedZoneId: !GetAtt CICFrontCustomDomain.RegionalHostedZoneId
        EvaluateTargetHealth: false

  CICFrontApiMapping:
    Type: AWS::ApiGatewayV2::ApiMapping
    Properties:
      DomainName: !Ref CICFrontCustomDomain
      ApiId: !Ref ApiGwHttpEndpoint
      Stage: !Ref APIStageDefault


  CicFrontSessionsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      # checkov:skip=CKV_AWS_28: Point in time recovery is not necessary for this table.
      TableName: !If
        - IsNotDevelopment
        - !Sub
          - "${SESSIONTABLENAME}"
          - SESSIONTABLENAME: !FindInMap [EnvironmentVariables, !Ref Environment, SESSIONTABLENAME]
        - !Sub
          - "${SESSIONTABLENAME}-${AWS::StackName}"
          - SESSIONTABLENAME: !FindInMap [EnvironmentVariables, !Ref Environment, SESSIONTABLENAME]
      BillingMode: "PAY_PER_REQUEST"
      AttributeDefinitions:
        - AttributeName: "id"
          AttributeType: "S"
      KeySchema:
        - AttributeName: "id"
          KeyType: "HASH"
      TimeToLiveSpecification:
        AttributeName: "expires"
        Enabled: true
      SSESpecification:
        # checkov:skip=CKV_AWS_119: Implement Customer Managed Keys in PYIC-1391
        SSEEnabled: true
        SSEType: KMS

# Alarms

  FE5XXErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: IsNotDevelopment
    Properties:
      AlarmName: !Sub "${AWS::StackName}-FE5XXErrorAlarm"
      AlarmDescription: !Sub 
        - "Trigger the warning alarm for Frontend 5xx Alarm ${RunbookUrl}"
        - RunbookUrl: !FindInMap [StaticVariables, urls, CICSupportManual]
      ActionsEnabled: true
      OKActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      AlarmActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      # Invocation count to be reviewed
      InsufficientDataActions: []
      Dimensions: []
      EvaluationPeriods: 5
      DatapointsToAlarm: 5
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching
      Metrics:
        - Id: errorThreshold
          Label: errorThreshold
          ReturnData: true
          Expression: IF(invocations<150 || error<5,0,errorPercentage)
        - Id: invocations
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: Count
              Dimensions:
                - Name: ApiId
                  Value: !Ref ApiGwHttpEndpoint
            Period: 60
            Stat: Sum
        - Id: error
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: 5xx
              Dimensions:
                - Name: ApiId
                  Value: !Ref ApiGwHttpEndpoint
            Period: 60
            Stat: Sum
        - Id: errorPercentage
          Label: errorPercentage
          ReturnData: false
          Expression: (error/invocations) * 100
  
  FE5XXErrorCriticalAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: IsNotDevelopment
    Properties:
      AlarmName: !Sub "${AWS::StackName}-FE5XXErrorCriticalAlarm"
      AlarmDescription: >
        Trigger the 5XX cricical alarm if errorThreshold exceeds 80% with 10 or more invocations
        and a minimum of 2 errors in 5 out of the last 5 minutes
      ActionsEnabled: true
      OKActions:
        - !ImportValue platform-alarm-pagerduty-alert-topic
        - !ImportValue platform-alarm-topic-critical-alert
      AlarmActions:
        - !ImportValue platform-alarm-pagerduty-alert-topic
        - !ImportValue platform-alarm-topic-critical-alert
      EvaluationPeriods: 5
      DatapointsToAlarm: 2
      Threshold: 80
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching
      Metrics:
        - Id: errorThreshold
          Label: errorThreshold
          ReturnData: true
          Expression: IF(invocations<10,0,errorPercentage)
        - Id: invocations
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: Count
              Dimensions:
                - Name: ApiId
                  Value: !Ref ApiGwHttpEndpoint
            Period: 60
            Stat: Sum
        - Id: error
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: 5xx
              Dimensions:
                - Name: ApiId
                  Value: !Ref ApiGwHttpEndpoint
            Period: 60
            Stat: Sum
        - Id: errorPercentage
          Label: errorPercentage
          ReturnData: false
          Expression: (error/invocations)*100

  FE4XXErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: "DeployAlarms"
    Properties:
      AlarmName: !Sub "${AWS::StackName}-FE4XXErrorAlarm"
      AlarmDescription: !Sub 
        - "Trigger the warning alarm for Frontend 4xx Alarm ${RunbookUrl}"
        - RunbookUrl: !FindInMap [StaticVariables, urls, CICSupportManual]
      ActionsEnabled: true
      OKActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      AlarmActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      InsufficientDataActions: [ ]
      Dimensions: [ ]
      EvaluationPeriods: 5
      DatapointsToAlarm: 2
      Threshold: 5
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching
      Metrics:
        - Id: errorThreshold
          Label: errorThreshold
          ReturnData: true
          Expression: IF(invocations<150 || error<2,0,errorPercentage)
        - Id: invocations
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: Count
              Dimensions:
                - Name: ApiId
                  Value: !Ref ApiGwHttpEndpoint
            Period: 60
            Stat: Sum
        - Id: error
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: 4xx
              Dimensions:
                - Name: ApiId
                  Value: !Ref ApiGwHttpEndpoint
            Period: 60
            Stat: Sum
        - Id: errorPercentage
          Label: errorPercentage
          ReturnData: false
          Expression: (error/invocations) * 100

  FELatencyAlarmP95:
    Type: AWS::CloudWatch::Alarm
    Condition: "DeployAlarms"
    Properties:
      AlarmName: !Sub "${AWS::StackName}-FELatencyAlarmP95"
      AlarmDescription: !Sub 
        - "Trigger the warning alarm for Frontend P95 Latency ${RunbookUrl}"
        - RunbookUrl: !FindInMap [StaticVariables, urls, CICSupportManual]
      ActionsEnabled: false
      OKActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      AlarmActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      InsufficientDataActions: [ ]
      Dimensions: [ ]
      EvaluationPeriods: 5
      DatapointsToAlarm: 2
      Threshold: 1000
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching
      Metrics:
        - Id: latencyThreshold
          Label: latencyThreshold
          ReturnData: true
          Expression: IF(invocations<25,0,latency95Percentile)
        - Id: invocations
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: Count
              Dimensions:
                - Name: ApiId
                  Value: !Ref ApiGwHttpEndpoint
            Period: 60
            Stat: Sum
        - Id: latency95Percentile
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: Latency
              Dimensions:
                - Name: ApiId
                  Value: !Ref ApiGwHttpEndpoint
            Period: 60
            Stat: p95

  FELatencyAlarmP99:
    Type: AWS::CloudWatch::Alarm
    Condition: "DeployAlarms"
    Properties:
      AlarmName: !Sub "${AWS::StackName}-FELatencyAlarmP99"
      AlarmDescription: !Sub 
        - "Trigger the warning alarm for Frontend P99 Latency ${RunbookUrl}"
        - RunbookUrl: !FindInMap [StaticVariables, urls, CICSupportManual]
      ActionsEnabled: false
      OKActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      AlarmActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      InsufficientDataActions: [ ]
      Dimensions: [ ]
      EvaluationPeriods: 5
      DatapointsToAlarm: 2
      Threshold: 2500
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching
      Metrics:
        - Id: latencyThreshold
          Label: latencyThreshold
          ReturnData: true
          Expression: IF(invocations<150,0,latency99Percentile)
        - Id: invocations
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: Count
              Dimensions:
                - Name: ApiId
                  Value: !Ref ApiGwHttpEndpoint
            Period: 60
            Stat: Sum
        - Id: latency99Percentile
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: Latency
              Dimensions:
                - Name: ApiId
                  Value: !Ref ApiGwHttpEndpoint
            Period: 60
            Stat: p99

  FELowContainerTaskCountAlarm:
    DependsOn:
      - CICFrontEcsCluster
    Type: AWS::CloudWatch::Alarm
    Condition: "DeployAlarms"
    Properties:
      AlarmName: !Sub "${AWS::StackName}-FELowContainerTaskCountAlarm"
      AlarmDescription: !Sub 
        - "Trigger a warning if the running container task count drops below 2 ${RunbookUrl}"
        - RunbookUrl: !FindInMap [StaticVariables, urls, CICSupportManual]
      ActionsEnabled: true
      AlarmActions:
        - !ImportValue platform-alarm-topic-critical-alert
      InsufficientDataActions: []
      Dimensions: []
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: 1
      ComparisonOperator: LessThanOrEqualToThreshold
      TreatMissingData: breaching
      Metrics:
        - Id: containerTaskCount
          ReturnData: true
          MetricStat:
            Metric:
              Namespace: ECS/ContainerInsights
              MetricName: TaskCount
              Dimensions:
                - Name: ClusterName
                  Value: !Ref CICFrontEcsCluster
            Period: 60
            Stat: Minimum

  FELowContainerTaskCountCriticalAlarm:
    DependsOn:
      - CICFrontEcsCluster
    Type: AWS::CloudWatch::Alarm
    Condition: "DeployAlarms"
    Properties:
      AlarmName: !Sub "${AWS::StackName}-FELowContainerTaskCountCriticalAlarm"
      AlarmDescription: !Sub 
        - "Trigger a critical alert if the running container task count drops below 1 ${RunbookUrl}"
        - RunbookUrl: !FindInMap [StaticVariables, urls, CICSupportManual]
      ActionsEnabled: false  # to be enabled once proved stable in production
      AlarmActions:
        - !ImportValue platform-alarm-topic-critical-alert
      InsufficientDataActions: []
      Dimensions: []
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: 0
      ComparisonOperator: LessThanOrEqualToThreshold
      TreatMissingData: breaching
      Metrics:
        - Id: containerTaskCount
          ReturnData: true
          MetricStat:
            Metric:
              Namespace: ECS/ContainerInsights
              MetricName: TaskCount
              Dimensions:
                - Name: ClusterName
                  Value: !Ref CICFrontEcsCluster
            Period: 60
            Stat: Maximum

# This alarm was copied and needs to be configured
  # FEMissingTranslationStringAlarm:
  #   Type: AWS::CloudWatch::Alarm
  #   Properties:
  #     AlarmName: !Sub "${AWS::StackName}-FEMissingTranslationStringAlarm"
  #     AlarmDescription: "????"
  #     ActionsEnabled: false
  #     OKActions:
  #       - !ImportValue platform-alarm-topic-slack-warning-alert
  #     AlarmActions:
  #       - !ImportValue platform-alarm-topic-slack-warning-alert
  #     InsufficientDataActions: [ ]
  #     Dimensions: [ ]
  #     EvaluationPeriods: 5
  #     DatapointsToAlarm: 2
  #     Threshold: 2500
  #     ComparisonOperator: GreaterThanOrEqualToThreshold
  #     TreatMissingData: notBreaching
  #     Metrics:
  #       - Id: latencyThreshold
  #         Label: latencyThreshold
  #         ReturnData: true
  #         Expression: IF(invocations<150,0,latency99Percentile)
  #       - Id: invocations
  #         ReturnData: false
  #         MetricStat:
  #           Metric:
  #             Namespace: AWS/ApiGateway
  #             MetricName: Count
  #             Dimensions:
  #               - Name: ApiId
  #                 Value: !Ref ApiGwHttpEndpoint
  #           Period: 60
  #           Stat: Sum
  #       - Id: latency99Percentile
  #         ReturnData: false
  #         MetricStat:
  #           Metric:
  #             Namespace: AWS/ApiGateway
  #             MetricName: Latency
  #             Dimensions:
  #               - Name: ApiId
  #                 Value: !Ref ApiGwHttpEndpoint
  #           Period: 60
  #           Stat: p99

  WarningAlarmDashboard:
    Type: AWS::CloudWatch::Dashboard
    Condition: IsNotDevelopment
    Properties:
      DashboardName: !Sub '${AWS::StackName}-Warning-Alarm-Overview'
      DashboardBody:
        Fn::Sub: >
          {
            "widgets": [
              {
                "height": 6,
                "width": 12,
                "y": 0,
                "x": 0,
                "type": "metric",
                "properties": {
                  "title": "CIC Front 5XX Error Alarm - ${AWS::StackName}",
                  "annotations": {
                    "alarms": ["${FE5XXErrorAlarm.Arn}"]
                  },
                  "view": "timeSeries",
                  "stacked": false
                }
              },
              {
                "height": 6,
                "width": 12,
                "y": 0,
                "x": 12,
                "type": "metric",
                "properties": {
                  "title": "CIC Front 4XX Error Alarm - ${AWS::StackName}",
                  "annotations": {
                    "alarms": ["${FE4XXErrorAlarm.Arn}"]
                  },
                  "view": "timeSeries",
                  "stacked": false
                }
              },
              {
                "height": 6,
                "width": 12,
                "y": 6,
                "x": 0,
                "type": "metric",
                "properties": {
                  "title": "CIC Front Latency Alarm P95 - ${AWS::StackName}",
                  "annotations": {
                    "alarms": ["${FELatencyAlarmP95.Arn}"]
                  },
                  "view": "timeSeries",
                  "stacked": false
                }
              },
              {
                "height": 6,
                "width": 12,
                "y": 6,
                "x": 12,
                "type": "metric",
                "properties": {
                  "title": "CIC Front Latency Alarm P99 - ${AWS::StackName}",
                  "annotations": {
                    "alarms": ["${FELatencyAlarmP99.Arn}"]
                  },
                  "view": "timeSeries",
                  "stacked": false
                }
              },
              {
                "height": 6,
                "width": 12,
                "y": 12,
                "x": 12,
                "type": "metric",
                "properties": {
                  "title": "CIC Front Low Container Task Count Warning - ${AWS::StackName}",
                  "annotations": {
                    "alarms": ["${FELowContainerTaskCountAlarm.Arn}"]
                  },
                  "view": "timeSeries",
                  "stacked": false
                }
              },
              {
                "height": 6,
                "width": 12,
                "y": 18,
                "x": 0,
                "type": "metric",
                "properties": {
                  "title": "CIC Front Low Container Task Count Critical Alarm - ${AWS::StackName}",
                  "annotations": {
                    "alarms": ["${FELowContainerTaskCountCriticalAlarm.Arn}"]
                  },
                  "view": "timeSeries",
                  "stacked": false
                }
              }
            ]
          }

  CriticalAlarmDashboard:
    Type: AWS::CloudWatch::Dashboard
    Condition: "DeployAlarms"
    Properties:
      DashboardName: !Sub '${AWS::StackName}-Critical-Alarm-Overview'
      DashboardBody:
        Fn::Sub: >
          {
            "widgets": [
              {
                "height": 6,
                "width": 12,
                "y": 0,
                "x": 0,
                "type": "metric",
                "properties": {
                  "title": "CIC Front Low Container Task Count Critical - ${AWS::StackName}",
                  "annotations": {
                    "alarms": ["${FELowContainerTaskCountCriticalAlarm.Arn}"]
                  },
                  "view": "timeSeries",
                  "stacked": false
                }
              }
            ]
          }

Outputs:
  StackName:
    Description: "CloudFormation stack name"
    Value: !Sub "${AWS::StackName}"
  CICFrontUrl:
    Description: >-
      The API Gateway URL which CIC Front can be invoked on.
    Value: !GetAtt  ApiGwHttpEndpoint.ApiEndpoint
  CICFrontGatewayId:
    Description: CIC Front API Gateway ID
    Export:
      Name: !Sub "${AWS::StackName}-CICFrontGatewayId"
    Value: !Ref ApiGwHttpEndpoint
  CICFrontSessionsTableName:
    Description: Table name for the FE sessions table
    Value: !Ref CicFrontSessionsTable
  CICCustomDomain:
    Description: CIC Custom Domain API Gateway ID
    Value: !Ref CICFrontCustomDomain
  CICIPVStubExecuteURL:
    Condition: IsNotProdLikeEnvironment
    Description: "CIC IPV Stub"
    Value:
      Fn::ImportValue: !Sub '${IPVStubStackName}-IPVStubExecuteUrl'
  CICTestHarnessURL:
    Condition: IsNotProdLikeEnvironment
    Description: "CIC Test Harness"
    Value: !FindInMap [EnvironmentVariables, !Ref Environment, TESTHARNESSURL]
  CICBackEndURL:
    Condition: IsNotProdLikeEnvironment
    Description: "CIC Back End"
    Value: !FindInMap [EnvironmentVariables, !Ref Environment, BACKENDURL]
  CICBackendSessionTableName:
    Condition: IsNotProdLikeEnvironment
    Description: "CIC Test Harness"
    Value: !FindInMap [EnvironmentVariables, !Ref Environment, BACKENDSESSIONTABLE]
